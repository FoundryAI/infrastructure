{
  "Parameters": {
    "Tag": {
      "Type": "String",
      "Default": "latest"
    },
    "Name": {
      "Type": "String"
    },
    "ContainerName": {
      "Type": "String"
    },
    "ContainerPort": {
      "Type": "Number",
      "Default": 3000
    },
    "Port": {
      "Type": "Number",
      "Default": 3000
    },
    "DesiredCount": {
      "Type": "Number",
      "Default": 0
    },
    "LoadBalancerName": {
      "Type": "String"
    },
    "Cluster": {
      "Type": "String"
    },
    "Repository": {
      "Type": "String"
    },
    "RdsDbName": {
      "Type": "String"
    },
    "RdsHostname": {
      "Type": "String"
    },
    "RdsUsername": {
      "Type": "String"
    },
    "RdsPassword": {
      "Type": "String"
    },
    "AwslogsGroup": {
      "Type": "String"
    },
    "AwslogsRegion": {
      "Type": "String"
    },
    "AwslogsStreamPrefix": {
      "Type": "String"
    }
  },
  "Resources": {
    "ECSServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Path": "/",
        "AssumeRolePolicyDocument": "{\n    \"Statement\": [{\n        \"Effect\": \"Allow\",\n        \"Principal\": { \"Service\": [ \"ecs.amazonaws.com\" ]},\n        \"Action\": [ \"sts:AssumeRole\" ]\n    }]\n}\n",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole"
        ]
      }
    },
    "Service": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": "Cluster",
        "Role": "ECSServiceRole",
        "DesiredCount": "DesiredCount",
        "TaskDefinition": "TaskDefinition",
        "LoadBalancers": [
          {
            "ContainerName": "ContainerName",
            "ContainerPort": "ContainerPort",
            "LoadBalancerName": "LoadBalancerName"
          }
        ]
      }
    },
    "TaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": "Name",
        "ContainerDefinitions": [
          {
            "Name": "ContainerName",
            "Image": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}:${Tag}",
            "Essential": true,
            "Memory": 128,
            "PortMappings": [
              {
                "ContainerPort": "ContainerPort",
                "HostPort": "Port"
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": [
                {
                  "awslogs-group": "AwslogsGroup",
                  "awslogs-region": "AwslogsRegion",
                  "awslogs-stream-prefix": "AwslogsStreamPrefix"
                }
              ]
            },
            "Environment": [
              {
                "Name": "Tag",
                "Value": "Tag"
              },
              {
                "Name": "RDS_DB_NAME",
                "Value": "RdsDbName"
              },
              {
                "Name": "RDS_HOSTNAME",
                "Value": "RdsHostname"
              },
              {
                "Name": "RDS_USERNAME",
                "Value": "RdsUsername"
              },
              {
                "Name": "RDS_PASSWORD",
                "Value": "RdsPassword"
              }
            ]
          }
        ]
      }
    }
  }
}